# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ WebSocket –∏ HTTP

## üìã –†–µ–∑—é–º–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ Socket.IO (WebSocket) –∏ HTTP –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –≤ Android-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–°–µ—Ä–≤–µ—Ä (server.js)**

#### HTTP Endpoint –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:
- **URL**: `POST /call-end`
- **Request Body**:
  ```json
  {
    "callId": "call_123...",
    "userId": "user_id"
  }
  ```
- **Response**:
  ```json
  {
    "status": "Success",
    "message": "Call ended successfully",
    "callId": "call_123..."
  }
  ```

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. ‚úÖ –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–∞ –ø–æ `callId` –∏–ª–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (`userId`)
2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–≤–æ–Ω–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ "ended"
3. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è `call_ended` –≤—Ç–æ—Ä–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É —á–µ—Ä–µ–∑ Socket.IO
4. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö (`pendingCalls`)

#### WebSocket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `socket.on("end_call")` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `callId` –∏–ª–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è `call_ended` –≤—Ç–æ—Ä–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É

---

### 2. **Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (WebRTCClient.kt)**

#### –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `endCall()`:
```kotlin
fun endCall() {
    Log.d(TAG, "üìû Ending call")
    currentCallId?.let { callId ->
        val endCallData = JSONObject().apply {
            put("callId", callId)
        }
        emitSafe("end_call", endCallData)
        
        // üî• –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ HTTP –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        endCallViaHttp(callId)
    }
    cleanupCall()
}
```

#### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `endCallViaHttp()`:
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ `/call-end`
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `Executors.newSingleThreadExecutor()`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è `call_ended`:
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `socket.on("call_ended")` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–≤–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ `cleanupCall()`
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ UI —á–µ—Ä–µ–∑ `listener.onCallEnded(fromUserId)`

---

## üîÑ –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: WebSocket
```
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ A ‚Üí Socket.IO ("end_call") ‚Üí –°–µ—Ä–≤–µ—Ä
                    ‚Üì
              –ù–∞—Ö–æ–¥–∏—Ç –∑–≤–æ–Ω–æ–∫
                    ‚Üì
              –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç "call_ended" ‚Üí Socket.IO ‚Üí –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ B
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: HTTP (fallback)
```
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ A ‚Üí HTTP POST /call-end ‚Üí –°–µ—Ä–≤–µ—Ä
                    ‚Üì
              –ù–∞—Ö–æ–¥–∏—Ç –∑–≤–æ–Ω–æ–∫
                    ‚Üì
              –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç "call_ended" ‚Üí Socket.IO ‚Üí –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ B
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ (WebSocket + HTTP)
2. **–ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–∞**: –ü–æ `callId` –∏–ª–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –û–±–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
4. **–ò—Å—Ç–æ—Ä–∏—è**: –°—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
5. **–û—á–∏—Å—Ç–∫–∞**: –ó–≤–æ–Ω–æ–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

---

## üìù –ó–∞–º–µ—Ç–∫–∏

- ‚úÖ HTTP endpoint –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –∫–æ–¥ –ø–æ–∏—Å–∫–∞ –∑–≤–æ–Ω–∫–∞, —á—Ç–æ –∏ WebSocket
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- ‚úÖ Graceful shutdown –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤–æ–Ω–æ–∫ –º–µ–∂–¥—É –¥–≤—É–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
2. –û–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–≤–æ–Ω–æ–∫
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Ç–æ—Ä–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–ª—É—á–∏–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HTTP:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤–æ–Ω–æ–∫ –º–µ–∂–¥—É –¥–≤—É–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å HTTP POST –Ω–∞ `/call-end` (–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ curl/Postman)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—É—á–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## üìå TODO (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `duration` (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–≤–æ–Ω–∫–∞) –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ –≤ `/status`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
